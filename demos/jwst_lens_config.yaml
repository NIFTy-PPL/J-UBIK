cpu: False

grid:
# fov: 8.064
  fov: 5
  fov_unit: arcsec

  pointing:
    ra: 64.66543063107049
    dec: -47.86462563973049
    unit: deg
    frame: icrs
    # rotation: -25
    rotation: -115

  sdim: 256
  edim: 3
  s_padding_ratio: 1.5
  e_padding_ratio: 1.0

  # e_keys: [f444w, f356w]

  energy_bin:
    e_min:
    # - 0.143
    - 0.200
    - 0.249  # eV
    - 0.311
    e_max:
    # - 0.188
    - 0.245
    - 0.311
    - 0.395
    e_ref:
    - 0.311

telescope:
  psf:
    webbpsf_path: '/home/jruestig/Data/JWST/WebbPsf/webbpsf-data_1.2.1/'
    psf_library: '/home/jruestig/Data/JWST/psf_library'
    psf_pixels: 32

  zero_flux:
    prior: ['lognormal', 0.1, 3]
    # prior: ['delta', 0.1, 3]

  rotation_and_shift:
    model: 'linear' # 'sparse', 'linear', 'nufft'
    subsample: 3
    priors: # will be ignored in case of sparse
      shift: ['normal', 0, 1.0e-1]  # pixel units
      rotation: ['normal', 0, 1.0e-1]
      rotation_unit: deg



files:
  res_dir: 'results/jwst_lens/mf_f356w_f444w_f560w_02'

  filter:
    # f115w: # NIRCam
    #   - './data/spt0418/f115w/jw01355016001_02101_00001_nrcb4/jw01355016001_02101_00001_nrcb4_cal.fits'
    #   - './data/spt0418/f115w/jw01355016001_02101_00002_nrcb4/jw01355016001_02101_00002_nrcb4_cal.fits'

    # f150w:
    #   - './data/spt0418/f150w/jw01355016001_02103_00001_nrcb4/jw01355016001_02103_00001_nrcb4_cal.fits'
    #   - './data/spt0418/f150w/jw01355016001_02103_00002_nrcb4/jw01355016001_02103_00002_nrcb4_cal.fits'

    # f200w:
    #   - './data/spt0418/f200w/jw01355016001_02105_00001_nrcb4/jw01355016001_02105_00001_nrcb4_cal.fits'
    #   - './data/spt0418/f200w/jw01355016001_02105_00002_nrcb4/jw01355016001_02105_00002_nrcb4_cal.fits'

    # f277w:
    #   - './data/spt0418/f277w/jw01355016001_02101_00001_nrcblong/jw01355016001_02101_00001_nrcblong_cal.fits'
    #   - './data/spt0418/f277w/jw01355016001_02101_00002_nrcblong/jw01355016001_02101_00002_nrcblong_cal.fits'

    f356w:
      - './data/spt0418/f356w/jw01355016001_02103_00001_nrcblong/jw01355016001_02103_00001_nrcblong_cal.fits'
      - './data/spt0418/f356w/jw01355016001_02103_00002_nrcblong/jw01355016001_02103_00002_nrcblong_cal.fits'

    f444w:
      - './data/spt0418/f444w/jw01355016001_02105_00001_nrcblong/jw01355016001_02105_00001_nrcblong_cal.fits'
      - './data/spt0418/f444w/jw01355016001_02105_00002_nrcblong/jw01355016001_02105_00002_nrcblong_cal.fits'

    f560w: # MIRI
      - './data/spt0418/f560w/jw01355015001_03101_00001_mirimage/jw01355015001_03101_00001_mirimage_cal.fits'
      - './data/spt0418/f560w/jw01355015001_03101_00002_mirimage/jw01355015001_03101_00002_mirimage_cal.fits'
      # - './data/spt0418/f560w/jw01355015001_03101_00003_mirimage/jw01355015001_03101_00003_mirimage_cal.fits'
      # - './data/spt0418/f560w/jw01355015001_03101_00004_mirimage/jw01355015001_03101_00004_mirimage_cal.fits'

    # f770w:
    #   - './data/spt0418/f770w/jw01355015001_05101_00001_mirimage/jw01355015001_05101_00001_mirimage_cal.fits'
    #   - './data/spt0418/f770w/jw01355015001_05101_00002_mirimage/jw01355015001_05101_00002_mirimage_cal.fits'
    #   - './data/spt0418/f770w/jw01355015001_05101_00003_mirimage/jw01355015001_05101_00003_mirimage_cal.fits'
    #   - './data/spt0418/f770w/jw01355015001_05101_00004_mirimage/jw01355015001_05101_00004_mirimage_cal.fits'

    # f1000w:
    #   - './data/spt0418/f1000w/jw01355015001_07101_00001_mirimage/jw01355015001_07101_00001_mirimage_cal.fits'
    #   - './data/spt0418/f1000w/jw01355015001_07101_00002_mirimage/jw01355015001_07101_00002_mirimage_cal.fits'
    #   - './data/spt0418/f1000w/jw01355015001_07101_00003_mirimage/jw01355015001_07101_00003_mirimage_cal.fits'
    #   - './data/spt0418/f1000w/jw01355015001_07101_00004_mirimage/jw01355015001_07101_00004_mirimage_cal.fits'

    # f1280w:
    #   - './data/spt0418/f1280w/jw01355015001_09101_00001_mirimage/jw01355015001_09101_00001_mirimage_cal.fits'
    #   - './data/spt0418/f1280w/jw01355015001_09101_00002_mirimage/jw01355015001_09101_00002_mirimage_cal.fits'
    #   - './data/spt0418/f1280w/jw01355015001_09101_00003_mirimage/jw01355015001_09101_00003_mirimage_cal.fits'
    #   - './data/spt0418/f1280w/jw01355015001_09101_00004_mirimage/jw01355015001_09101_00004_mirimage_cal.fits'

    # f1500w:
    #   - './data/spt0418/f1500w/jw01355015001_11101_00001_mirimage/jw01355015001_11101_00001_mirimage_cal.fits'
    #   - './data/spt0418/f1500w/jw01355015001_11101_00002_mirimage/jw01355015001_11101_00002_mirimage_cal.fits'
    #   - './data/spt0418/f1500w/jw01355015001_11101_00003_mirimage/jw01355015001_11101_00003_mirimage_cal.fits'
    #   - './data/spt0418/f1500w/jw01355015001_11101_00004_mirimage/jw01355015001_11101_00004_mirimage_cal.fits'

    # f1800w:
    #   - './data/spt0418/f1800w/jw01355015001_13101_00001_mirimage/jw01355015001_13101_00001_mirimage_cal.fits'
    #   - './data/spt0418/f1800w/jw01355015001_13101_00002_mirimage/jw01355015001_13101_00002_mirimage_cal.fits'
    #   - './data/spt0418/f1800w/jw01355015001_13101_00003_mirimage/jw01355015001_13101_00003_mirimage_cal.fits'
    #   - './data/spt0418/f1800w/jw01355015001_13101_00004_mirimage/jw01355015001_13101_00004_mirimage_cal.fits'

    # f2100w:
    #   - './data/spt0418/f2100w/jw01355015001_15101_00001_mirimage/jw01355015001_15101_00001_mirimage_cal.fits'
    #   - './data/spt0418/f2100w/jw01355015001_15101_00002_mirimage/jw01355015001_15101_00002_mirimage_cal.fits'
    #   - './data/spt0418/f2100w/jw01355015001_15101_00003_mirimage/jw01355015001_15101_00003_mirimage_cal.fits'
    #   - './data/spt0418/f2100w/jw01355015001_15101_00004_mirimage/jw01355015001_15101_00004_mirimage_cal.fits'
    #   - './data/spt0418/f2100w/jw01355015001_15101_00005_mirimage/jw01355015001_15101_00005_mirimage_cal.fits'
    #   - './data/spt0418/f2100w/jw01355015001_15101_00006_mirimage/jw01355015001_15101_00006_mirimage_cal.fits'
    #   - './data/spt0418/f2100w/jw01355015001_15101_00007_mirimage/jw01355015001_15101_00007_mirimage_cal.fits'
    #   - './data/spt0418/f2100w/jw01355015001_15101_00008_mirimage/jw01355015001_15101_00008_mirimage_cal.fits'
    #   - './data/spt0418/f2100w/jw01355015001_15101_00009_mirimage/jw01355015001_15101_00009_mirimage_cal.fits'
    #   - './data/spt0418/f2100w/jw01355015001_15101_00010_mirimage/jw01355015001_15101_00010_mirimage_cal.fits'
    #   - './data/spt0418/f2100w/jw01355015001_15101_00011_mirimage/jw01355015001_15101_00011_mirimage_cal.fits'
    #   - './data/spt0418/f2100w/jw01355015001_15101_00012_mirimage/jw01355015001_15101_00012_mirimage_cal.fits'

lensing: 
  spaces:
    lens_space:
      padding_ratio: 1.5
      Npix:
        - 256
        - 256
      fov: 5

    source_space:
      padding_ratio: 1.5
      Npix:
        - 256
        - 256
      distance:
        - 0.008
        - 0.008

  model:
    source:
      light:
          mean:
            gaussian_01:
              i0: ['log_normal', 4.0e-2, 8.0e-3]
              center:
                distribution: 'normal'
                mean: 0
                sigma: 0.1
              covariance:
                distribution: 'log_normal'
                mean: 0.06
                sigma: 0.01
              off_diagonal:
                sigma: 10
                distribution: 'normal'
                mean: 0.0

            gaussian_02:
              i0: ['log_normal', 4.0e-2, 8.0e-3]
              center:
                distribution: 'normal'
                mean: 
                  - 0.4
                  - -0.4
                sigma: 
                  - 0.1
                  - 0.1
              covariance:
                distribution: 'log_normal'
                mean: 0.06
                sigma: 0.01
              off_diagonal:
                sigma: 10
                distribution: 'normal'
                mean: 0.0

          perturbations:
            ubik:
              grid:
                edim: 3
                e_padding_ratio: 1.0
                # e_keys: [f444w, f356w]
              energy_bin:
                e_min:
                - 0.0385  # 0.200 
                - 0.0488  # 0.249  @ z=4.1 (eV)
                - 0.0609  # 0.311  # 
                e_max:                    
                - 0.0471  # 0.245
                - 0.0609  # 0.311  # 
                - 0.0775  # 0.395  # 
                e_ref:                    
                - 0.0609  # 0.311  # 

              priors:
                  diffuse:
                    spatial:
                      offset:
                        offset_mean: -2.0
                        offset_std: Null
                          # - 0.7
                          # - 0.4
                      fluctuations:
                        fluctuations:
                          - 1.6
                          - 0.2
                        loglogavgslope:
                          - -3.2
                          - 0.3
                        flexibility:
                          - 0.8
                          - 0.08
                        asperity: Null
                        non_parametric_kind: "power"
                        # harmonic_type: "Fourier"
                      prefix: diffuse_spatial_

                    plaw:
                      offset:
                        offset_mean: -2.0
                        offset_std:
                          - 1.5
                          - 0.5
                      fluctuations:
                        fluctuations:
                          - 0.5
                          - 0.05
                        loglogavgslope:
                          - -4.5
                          - 0.5
                        flexibility:
                          - 0.5
                          - 0.05
                        asperity:
                          Null
                        non_parametric_kind: "power"
                        # harmonic_type: "Fourier"
                      prefix: diffuse_plaw_


    lens:
      light:
        mean:
          exponentialpower: # i0*exp(-a(r/re)**b)
            i0: ['delta', 5.0e-2, 8.0e-3]
            # a: ['lognormal', 0.2, 0.1]
            a: ['delta', 0.2, 0.1]
            re:
              distribution: 'log_normal'
              mean: 0.03
              sigma: 0.01
            b:
              distribution: 'uniform'
              min: 0.2  # 0.25 deVaucouleurs profile 
              max: 3.0
            center:
              distribution: 'normal'
              mean: 0.0
              sigma: 0.01
            q:
              distribution: 'uniform'
              min: 0.68
              max: 1.0
            theta:
              distribution: 'normal'
              mean: 0.0
              sigma: 10

            radial_correction: 
              extent_factor: 1.5
              Npix: 128
              matern: 
                amplitude:
                  offset_mean: 0.
                  offset_std: Null
                    # - 1.0e-1
                    # - 1.0e-2
                fluctuations:
                  scale:
                    - 0.8e+0
                    - 3.0e-1
                  cutoff:
                    - 0.1
                    - 1.0e-2
                  loglogslope:
                    - -4.0
                    - 5.0e-1

        perturbations:
          ubik:
            grid:
              edim: 3
              e_padding_ratio: 1.0
              # e_keys: [f444w, f356w]

            energy_bin: # eV
              e_min:
              # - 0.143
              - 0.200
              - 0.249  # eV
              - 0.311
              e_max:
              # - 0.188
              - 0.245
              - 0.311
              - 0.395
              e_ref:
              - 0.311

            plaw_only: True 
            # Only take the plaw for the energy correlation.
            # Spatial model is only the mean model !

            priors:
                diffuse:

                  spatial:
                    offset:
                      offset_mean: 0.0
                      offset_std:
                        - 1.2
                        - 0.5
                    fluctuations:
                      fluctuations:
                        - 1.6
                        - 0.1
                      loglogavgslope:
                        - -3.2
                        - 0.3
                      flexibility:
                        - 0.8
                        - 0.08
                      asperity: Null
                      non_parametric_kind: "power"
                      # harmonic_type: "Fourier"
                    prefix: diffuse_spatial_

                  plaw:
                    offset:
                      offset_mean: +2.0
                      offset_std:
                        - 1.0
                        - 0.5
                    fluctuations:
                      fluctuations:
                        - 0.5
                        - 0.05
                      loglogavgslope:
                        - -4.5
                        - 0.5
                      flexibility:
                        - 0.5
                        - 0.05
                      asperity:
                        Null
                      non_parametric_kind: "power"
                      # harmonic_type: "Fourier"
                    prefix: diffuse_plaw_


      convergence:
        mean:
          piemd:
            b:
              distribution: 'log_normal'
              mean: 1.3
              sigma: 0.1
            rs:
              distribution: 'log_normal'
              mean: 0.1
              sigma: 0.05
            center:
              distribution: 'normal'
              mean: 0.0
              sigma: 0.1
            q:
              distribution: 'uniform'
              min: 1.0
              max: 1.25
            theta:
              distribution: 'normal'
              mean: 0.0
              sigma: 10

        perturbations: 
          cfm:
            amplitude:
              offset_mean: 0.0
              offset_std:
                - 1.e-1
                - 1.e-6
            fluctuations:
              fluctuations:
                - 0.5
                - 5.e-2
              loglogavgslope:
                - -6.0
                - 0.7
              flexibility:
                - 0.5
                - 1.0
              asperity: null
                # - 0.1
                # - 0.5

      deflection:
        poisson_padding: 2
        shear:
          shear:
            strength:
              distribution: 'normal'
              mean: 0
              sigma: 0.001
            theta:
              distribution: 'normal'
              mean: 0.0
              sigma: 10
            center:
              distribution: null
              mean: 0.
              sigma: 0.2



minimization:
    key: 2228
    resume: False
    n_total_iterations: 15

    delta:
      switches: [0, 10, 15]
      values: [1.e-5, 1.e-6, 1.e-7]

    samples:
      switches: [0, 5, 9]
      n_samples: [5, 6]
      mode: [linear_resample, nonlinear_resample]
      # Possible modes:
      # - "linear_sample",
      # - "linear_resample",
      # - "nonlinear_sample",
      # - "nonlinear_resample",
      # - "nonlinear_update",


      # lin_absdelta: [Null, Null, 0.00001]
      lin_maxiter: [50, 100, 200]

      # nonlin_xtol: [Null, 0.1, 0.01]
      nonlin_maxiter: [7, 13]
      # nonlin_cg_atol: [0.1, 0.01]
      # nonlin_cg_maxiter: [20, 30]

    kl_minimization:
      switches: [0, 3, 7]
      # kl_absdelta: [Null, 1.0e-2, 1.0e-4]
      kl_maxiter: [7, 15]
